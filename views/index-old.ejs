<% include include/head.ejs %>

<body>
  
  <main role="main" class="flex-shrink-0">

    <div class="container">
      <h1 class="mt-5"><%= title %></h1>
      
      <% include include/nav.ejs %>

      <p class="lead"> 
        <div class="row" id="chart" width="100%"></div>
      </p>
      
      <div id="app">
        <p>
          <h2>Blocks</h2>
          
          <div class="list-group">

            <a href="#" class="list-group-item list-group-item-action" v-for="action in actions">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1"> {{ action.block_num }} </h5><br /> 
                  <small> {{ action.trx_id }} </small>
              </div>
              <p class="mb-1"><pre><code> {{ action.act.data }}</code></pre></p>
              <small> {{ action.block_time }} </small>
            </a>

          </div>

            <div class="alert alert-info" role="alert" v-show="msgsuccess">{{ msgsuccess }}</div>
            <div class="alert alert-warning" role="alert" v-show="msgwarning">{{ msgwarning }}</div>
          
        </p>
      </div>

    </div>
  </main>  

  <% include include/footer.ejs %>
  <% include include/scripts.ejs %>
  <% include include/google_analytics.ejs %>
  
  <script src="js/realTimeLineChart.js"></script>

  <script>
    'use strict';

    var data = {
      actions: {},
      msgsuccess: '',
      msgwarning: ''
    };

    new Vue({
      el: '#app',
      data: data
    });

    var socket = io();

    var lineArr = [];
    var duration = 2000;

    var wl = $("#chart").outerWidth();
    var chartLine = realTimeLineChart(wl, 500, duration);

    socket.on('block', (_data) => {

      // console.log('CLIENT BLOCK block -> ' + _data);

      var _d = JSON.parse(_data);

      updateLine(_d.block_time, _d.receipt.cpu_usage_us, _d.net_usage);

      data.actions = _d.action_traces

    });

    socket.on('update', _data => {
      console.log('CLIENT BLOCK update -> ' + _data);
      data.msgsuccess = _data;
    });

    socket.on('error', _data => {
      console.log('CLIENT BLOCK error -> ' + _data);
      data.msgwarning = _data;
    });

    let updateLine = (date, cpu, net) => {

      var now = new Date(date);

      var lineData = {
        time: now,
        cpu: cpu,
        net: net
      };

      lineArr.push(lineData);

      if (lineArr.length > 30) {
        lineArr.shift();
      }

      d3.select("#chart").datum(lineArr).call(chartLine);

    };

  </script>

  </body>
</html>